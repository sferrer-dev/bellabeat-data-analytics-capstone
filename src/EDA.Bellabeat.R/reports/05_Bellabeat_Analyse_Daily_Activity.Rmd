---
title: "Bellabeat - Daily Activity Analysis"
output:
  html_document:
    theme: cosmo
    css: css/styles.css
    highlight: tango
    toc: true
    toc_depth: 3
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
# Global chunk options
knitr::opts_chunk$set(
  echo    = FALSE,
  message = FALSE,
  warning = FALSE
)
```

```{r libraries}
library(DBI)
library(odbc)
library(dplyr)
library(ggplot2)
library(tidyr)
library(patchwork)
library(scales)
```

<!-- Loading SQL Server view -->

```{r connect-and-load}
# SQL Server connection (localhost)
con <- dbConnect(
  odbc::odbc(),
  Driver   = "ODBC Driver 18 for SQL Server",
  Server   = "localhost",
  Database = "bellabeat_data",
  Trusted_Connection = "Yes",
  Encrypt  = "no"                  # useful locally to bypass mandatory TLS
)

# Reading analytic view
df <- dbGetQuery(con, "
  SELECT *
  FROM rpt.vDailyActivity_Insights
")

# Cleaning date type + factors
df <- df %>%
  mutate(
    ActivityDate = as.Date(ActivityDate),
    DayOfWeek    = factor(DayOfWeek),
    PartOfWeek   = factor(PartOfWeek)
  )
```

# Line Charts: Steps per Day

```{r plot-steps-per-day}
# Raw chart
p1 <- ggplot(df, aes(x = ActivityDate, y = TotalSteps)) +
  geom_line(color = "steelblue", linewidth = 0.3) +
  geom_point(color = "steelblue", size = 0.6) +
  scale_x_date(
    date_breaks = "1 week",
    date_labels = "%A %d %b"
  ) +
  scale_y_continuous(
    limits = c(0, 25000),
    labels = label_comma(big.mark = " ", decimal.mark = ",")
  ) +
  labs(
    title = "Daily Evolution\nof Step Count",
    x     = "Activity Date",
    y     = "Number of Steps"
  ) +
  theme(
    plot.title   = element_text(size = 12),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    axis.text.x  = element_text(angle = 45, hjust = 1)
  )
```

```{r curve-mean-per-day}
# Daily aggregation
df_daily <- df %>%
  group_by(ActivityDate) %>%
  summarise(
    AvgSteps = mean(TotalSteps, na.rm = TRUE),
    .groups  = "drop"
  )

# Daily trend chart (mean)
p2 <- ggplot(df_daily, aes(x = ActivityDate, y = AvgSteps)) +
  geom_line(color = "black") +
  geom_point(color = "black") +
  scale_x_date(
    date_breaks = "1 week",
    date_labels = "%A %d %b"
  ) +
  scale_y_continuous(
    limits = c(0, 25000),
    labels = label_comma(big.mark = " ", decimal.mark = ",")
  ) +
  labs(
    title = "Daily Trend\nof Average Step Count",
    x     = "Activity Date",
    y     = "Average Daily Steps (all users)"
  ) +
  theme(
    plot.title   = element_text(size = 12),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    axis.text.x  = element_text(angle = 45, hjust = 1)
  )
```

```{r plot-compare-steps}
(p1 | p2) +
  plot_annotation(title = "Comparison of Raw Steps vs Daily Average") +
  plot_layout(widths = c(1.3, 1.3))
```

## Daily Evolution of Step Count {.unnumbered}

The evolution of steps highlights strong individual variability: on a given day, step counts range from just a few thousand to over 20,000, creating significant dispersion and isolated peaks. These values primarily reflect differences between users rather than a shared temporal pattern.

After aggregating by date, a clear trend appears: the average step count gradually increases from early March to early April, rising from around **3,000–4,000** to **6,000–7,500** steps. Several noticeable dips occur (around March 18, March 31, and April 12), caused either by a general drop in activity or a reduced number of active users. Overall, the trend indicates a collective increase in activity over time.

# Barplot: Active vs Sedentary Minutes

```{r barplot-active-vs-sedentary-minutes}
df_long <- df %>%
  select(ActivityDate, TotalActiveMinutes, SedentaryMinutes) %>%
  pivot_longer(
    cols      = c(TotalActiveMinutes, SedentaryMinutes),
    names_to  = "TypeMinutes",
    values_to = "Minutes"
  ) %>%
  mutate(
    TypeMinutes = recode(
      TypeMinutes,
      TotalActiveMinutes = "Active",
      SedentaryMinutes   = "Sedentary"
    )
  )

ggplot(df_long, aes(x = ActivityDate, y = Minutes, fill = TypeMinutes)) +
  geom_col(position = "stack") +
  scale_x_date(
    date_breaks = "1 week",
    date_labels = "%A %d %b"
  ) +
  labs(
    title = "Active vs Sedentary Minutes per Day",
    x     = "Date",
    y     = "Minutes",
    fill  = "Type of Minutes"
  ) +
  theme(
    plot.title   = element_text(size = 12),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    axis.text.x  = element_text(angle = 45, hjust = 1)
  )
```

## Clear Dominance of Sedentary Minutes {.unnumbered}

Sedentary minutes account for the vast majority of total daily time, indicating predominantly inactive behavior. From late March and especially early April, total minutes rise sharply, driven by an increase in the number of active users in the dataset. Active minutes also increase but remain far below sedentary minutes, even on the most active days.

# Heatmap: Activity by Day of Week

```{r heatmap-activity-per-dow}
df_heat <- df %>%
  group_by(DayOfWeek, DayOfWeekNumber, PartOfWeek) %>%
  summarise(
    MeanSteps = mean(TotalSteps, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    DayOfWeek = factor(
      DayOfWeek,
      levels = DayOfWeek[order(DayOfWeekNumber)]
    )
  )

ggplot(df_heat, aes(x = DayOfWeek, y = PartOfWeek, fill = MeanSteps)) +
  geom_tile() +
  scale_fill_gradient(
    low  = "#F2F0F7",
    high = "#54278F",
    labels = label_comma(big.mark = " ", decimal.mark = ",")
  ) +
  labs(
    title = "Average Steps by Day of Week",
    x     = "Day of Week",
    y     = "Type of Day",
    fill  = "Average Steps"
  )
```

## Weekend vs Weekday Contrast {.unnumbered}

The analysis reveals a clear pattern: users walk significantly more on weekends than during weekdays. Saturday is the most active day, followed by Sunday, while Tuesday is the least active. Among weekdays, Wednesday stands out with slightly higher activity.

This distribution likely reflects increased availability during weekends, naturally boosting step counts.

# Correlation Between Active Minutes and Calories Burned

```{r correlation-activity-calories}
ggplot(df, aes(x = TotalActiveMinutes, y = Calories)) +
  geom_point(
    aes(color = PartOfWeek),
    alpha = 0.55,
    size  = 1.7
  ) +
  geom_smooth(
    method    = "lm",
    se        = FALSE,
    linewidth = 0.9,
    color     = "blue"
  ) +
  scale_y_continuous(
    labels = label_comma(big.mark = " ", decimal.mark = ",")
  ) +
  labs(
    title = "Relationship Between Active Minutes and Calories Burned",
    x     = "Total Active Minutes",
    y     = "Calories Burned",
    color = "Part of Week"
  )
```

## Positive Relationship Between Activity and Calories {.unnumbered}

The scatterplot shows a clear positive relationship: more active minutes correspond to more calories burned. Both weekday and weekend observations follow nearly the same trend. Active minutes are therefore the primary driver of caloric expenditure, regardless of the day of the week.

<!-- Disconnect -->

```{r disconnect}
if (exists("con") && DBI::dbIsValid(con)) {
  DBI::dbDisconnect(con)
}
```

