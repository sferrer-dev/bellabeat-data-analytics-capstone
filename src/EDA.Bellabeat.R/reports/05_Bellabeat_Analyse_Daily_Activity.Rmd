---
title: "Bellabeat - Analyse Daily Activity"
output:
  html_document:
    theme: cosmo
    css: css/styles.css
    highlight: tango
    toc: true
    toc_depth: 3
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
# Global chunk options
knitr::opts_chunk$set(
  echo    = FALSE,
  message = FALSE,
  warning = FALSE
)
```

```{r libraries}
library(DBI)
library(odbc)
library(dplyr)
library(ggplot2)
library(tidyr)
library(patchwork)
library(scales)
```

<!-- Chargement de la vue SQL Server -->

```{r connect-and-load}
# Connexion SQL Server (localhost)
con <- dbConnect(
  odbc::odbc(),
  Driver   = "ODBC Driver 18 for SQL Server",
  Server   = "localhost",           
  Database = "bellabeat_data",
  Trusted_Connection = "Yes",
  Encrypt  = "no"                   # utile en local pour éviter TLS obligatoire
)

# Lecture de la vue analytique
df <- dbGetQuery(con, "
  SELECT *
  FROM rpt.vDailyActivity_Insights
")

# Nettoyage type Date + facteurs
df <- df %>%
  mutate(
    ActivityDate = as.Date(ActivityDate),
    DayOfWeek    = factor(DayOfWeek),
    PartOfWeek   = factor(PartOfWeek)
  )

```


# Courbes : Pas par jour

```{r plot-steps-per-day}
# Graphique brut : une ligne par utilisatrice
p1 <- ggplot(df, aes(x = ActivityDate, y = TotalSteps)) +
  geom_line(color = "steelblue", linewidth = 0.3) +
  geom_point(color = "steelblue", size = 0.6) +
  scale_x_date(
    date_breaks = "1 week",
    date_labels = "%A %d %b"          # labels compacts, lisibles
  ) +
  scale_y_continuous(
    limits = c(0, 25000),
    labels = label_comma(big.mark = " ", decimal.mark = ",")
  ) +
  labs(
    title = "Évolution quotidienne \ndu nombre de pas",
    x     = "Date de l'activité",
    y     = "Nombre de pas"
  ) +
  theme(
    plot.title   = element_text(size = 12),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r curve-mean-per-day}
# Agrégation au niveau jour
df_daily <- df %>%
  group_by(ActivityDate) %>%
  summarise(
    AvgSteps = mean(TotalSteps, na.rm = TRUE),
    .groups  = "drop"
  )

# Graphique de tendance journalière (moyenne)
p2 <- ggplot(df_daily, aes(x = ActivityDate, y = AvgSteps)) +
  geom_line(color = "black") +
  geom_point(color = "black") +
  scale_x_date(
    date_breaks = "1 week",
    date_labels = "%A %d %b"
  ) +
  scale_y_continuous(
    limits = c(0, 25000),
    labels = label_comma(big.mark = " ", decimal.mark = ",")
  ) +
  labs(
    title = "Tendance journalière \ndu nombre moyen de pas",
    x     = "Date d'activité",
    y     = "Pas moyens par jour (tous utilisateurs)"
  ) +
  theme(
    plot.title   = element_text(size = 12),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r plot-compare-steps}
(p1 | p2) +
  plot_annotation(title = "Comparaison des pas bruts et de la moyenne journalière") +
  plot_layout(widths = c(1.3, 1.3))

```

## Évolution quotidienne du nombre de pas {.unnumbered}

L’évolution des pas met surtout en évidence une forte hétérogénéité individuelle : pour une même date, les volumes journaliers varient de quelques milliers à plus de 20 000 pas, ce qui crée une dispersion importante et des pics isolés. Ces valeurs reflètent d’abord les différences entre utilisatrices plutôt qu’un schéma temporel commun.

En agrégeant les données par date, une tendance claire émerge : le nombre moyen de pas augmente progressivement de début mars à début avril, passant d’environ 3 000–4 000 à 6 000–7 500 pas. Plusieurs chutes ponctuelles apparaissent (vers le 18 mars, le 31 mars et le 12 avril), liées soit à une baisse d’activité générale, soit à une diminution du nombre d’utilisatrices actives ces jours-là. L’ensemble traduit une dynamique collective de plus grande activité au fil du temps.


# Barplot : active minutes vs. sedentary minutes

```{r barplot-active-vs-sedentary-minutes}
df_long <- df %>%
  select(ActivityDate, TotalActiveMinutes, SedentaryMinutes) %>%
  pivot_longer(
    cols      = c(TotalActiveMinutes, SedentaryMinutes),
    names_to  = "TypeMinutes",
    values_to = "Minutes"
  ) %>%
  mutate(
    TypeMinutes = recode(
      TypeMinutes,
      TotalActiveMinutes = "Actives",
      SedentaryMinutes   = "Sédentaires"
    )
  )

# Graphique 
ggplot(df_long, aes(x = ActivityDate, y = Minutes, fill = TypeMinutes)) +
  geom_col(position = "stack") +
  scale_x_date(
    date_breaks = "1 week",
    date_labels = "%A %d %b"
  ) +
  labs(
    title = "Minutes actives vs. minutes sédentaires par jour",
    x     = "Date",
    y     = "Minutes",
    fill  = "Type de minutes"
  ) +
  theme(
    plot.title   = element_text(size = 12),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```


## Dominance nette des minutes sédentaires {.unnumbered}

Les minutes sédentaires constituent l’essentiel du volume quotidien, ce qui traduit un comportement global majoritairement statique. À partir de la fin mars, puis surtout au début avril, on observe une hausse brusque du total des minutes enregistrées, liée à une augmentation du nombre d’utilisatrices actives dans les données. Les minutes actives progressent en parallèle, mais leur part reste nettement inférieure à celle des minutes sédentaires, même lors des journées où l’activité totale est la plus élevée.


```{r disconnect}
if (exists("con") && DBI::dbIsValid(con)) {
  DBI::dbDisconnect(con)
}