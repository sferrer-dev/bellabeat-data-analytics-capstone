---
title: "Bellabeat – Data Profiling and Exploratory Data Analysis"
author: "Stef"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  pdf_document:
    latex_engine: xelatex
    number_sections: true
  html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float: true
    css: styles/styles.css
    number_sections: true
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
# Global chunk options
knitr::opts_chunk$set(
  echo    = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center"
)

# Packages
library(readr)
library(dplyr)
library(purrr)
library(tidyr)
library(skimr)
library(here)
library(knitr)

# Custom project configuration
source(here("config", "config.R"))
# Custom profiling function
source(here("scripts", "profile_csv.R"))

# Avoid scientific notation by default
options(scipen = 999)
```

```{r batch-profiling, echo=FALSE}
# Batch profiling of all CSV files
# Retrieve the list of all CSV files located in the data directory.
# - pattern = "\\.csv$"   → Only files ending with ".csv"
# - full.names = TRUE     → Return full file paths (needed for reading)
csv_files  <- list.files(
  here(data_dir), 
  pattern = "\\.csv$", 
  full.names = TRUE)
# Apply the profiling function to each CSV file.
# purrr::map() iterates over the list of file paths and returns
# a list of profiling results (one element per CSV).
profiles <- purrr::map(csv_files, profile_csv)
# Name the list using the filenames (without the path)
names(profiles) <- basename(csv_files)
```

```{r render-profiles, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
purrr::iwalk(
  .x = profiles,
  .f = function(p, filename) {
# Section title for this file
    cat("\n\n# File profile: `", filename, "`\n\n", sep = "")
# 1. Column profile
    cat("## Column profile\n\n")
    print(
      kable(p$col_profile, 
            caption = paste("Variable profile -", filename)
            )
      )
# 2. Numerical statistics
    cat("\n\n## Numerical statistics\n\n")
    print(kable(p$num_stats, 
                caption = paste("Numerical statistics -", filename)
                )
          )
# 3. Skimr summary
    cat("\n\n## Skimr summary\n\n")
    print(kable(p$skim, 
                caption = paste("Skimr summary -", filename)
                )
          )
# 4. Raw data overview
    cat("\n\n## Raw data overview\n\n")
    print(
      p$data %>%
        head(10) %>%
        kable(
          caption = paste("Overview (first 10 lines) -", filename)
        )
    )
  }
)
```
