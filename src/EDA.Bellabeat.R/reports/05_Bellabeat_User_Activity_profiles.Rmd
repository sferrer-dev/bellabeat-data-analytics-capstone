---
title: "User Activity Profiles"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_depth: 3
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
# Global chunk options
knitr::opts_chunk$set(
  echo    = FALSE,
  message = FALSE,
  warning = FALSE
)
```

```{r libraries}
library(DBI)
library(odbc)
library(dplyr)
library(ggplot2)
library(scales)
library(tidyr)
library(ggrepel)
```

<!-- Loading the SQL Server view -->

```{r connect-and-load}

con <- dbConnect(
  odbc(),
  Driver   = "ODBC Driver 18 for SQL Server",
  Server   = "localhost",
  Database = "bellabeat_data",
  Trusted_Connection = "Yes",
  Encrypt  = "no"
)

df_daily <- dbGetQuery(con, "
    SELECT *
    FROM rpt.vDailyIntensityFromMinutes;
")
```

```{r features-per-user}
# Aggregation of daily data at the "user" level.
# The goal is to build a set of descriptive variables
# (features) to analyze and segment activity profiles.
df_users <- df_daily %>%
  
  # Grouping by user identifier
  group_by(Id) %>%
  
  # Calculation of mean and cumulative indicators over the entire observed period
  summarise(
    # Total number of available days for this user
    n_days = n(),
    
    # Average daily step count
    mean_steps = mean(TotalSteps, na.rm = TRUE),
    
    # Average energy expenditure (calories)
    mean_calories = mean(Calories, na.rm = TRUE),
    
    # Average minutes spent sedentary
    mean_sedentary_min = mean(SedentaryMinutes, na.rm = TRUE),
    
    # Average minutes of moderate + vigorous activity (Fairly + Very Active)
    mean_active_min = mean(FairlyActiveMinutes + VeryActiveMinutes, na.rm = TRUE),
    
    # Average minutes of light activity
    mean_light_min = mean(LightlyActiveMinutes, na.rm = TRUE),
    
    # Average daily intensity from the consolidated view
    mean_intensity = mean(AvgIntensity, na.rm = TRUE),
    
    # Maximum intensity observed among recorded days
    max_intensity = max(MaxIntensity, na.rm = TRUE),
    
    # Average minutes per intensity zone (from minute-level aggregation)
    mean_minutes_very   = mean(MinutesVery_Calc, na.rm = TRUE),
    mean_minutes_moder  = mean(MinutesModerate_Calc, na.rm = TRUE),
    mean_minutes_light  = mean(MinutesLight_Calc, na.rm = TRUE),
    mean_minutes_sedent = mean(MinutesSedentary_Calc, na.rm = TRUE),
    
    # Average proportion of active minutes (moderate + very)
    # relative to all recorded minutes (all zones combined)
    prop_active_minutes = (mean_minutes_moder + mean_minutes_very) /
                          (mean_minutes_sedent + mean_minutes_light +
                           mean_minutes_moder + mean_minutes_very)
  ) %>%
  
  # Remove grouping
  ungroup()
```

# Scatter plot of users' daily walking activity

```{r scatter-users-colored}
# Prepare the data: convert Id to factor for discrete coloring
df_users_col <- df_users %>%
  mutate(Id = factor(Id))

ggplot(df_users_col,
       aes(x = mean_steps, y = mean_intensity, colour = Id)) +
  
  # Scatter plot (one color per user)
  geom_point(size = 3, alpha = 0.9) +
  
  # Regression line (a single one for all users)
  geom_smooth(
    aes(x = mean_steps, y = mean_intensity),
    method = "lm",
    se = FALSE,
    colour = "black",
    linewidth = 0.5,
    inherit.aes = FALSE
  ) +
  
  # Annotation
  annotate(
    "text",
    x = 6000, y = 0.08,
    label = "Higher average step counts\ncorrespond to higher daily intensity.",
    hjust = 0, vjust = 1,
    size = 4
  ) +
  
  scale_x_continuous(
    labels = scales::label_comma(big.mark = " ", decimal.mark = ",")
  ) +
  
  labs(
    title  = "User Profiles: Step Volume and Average Intensity",
    x      = "Average steps per day",
    y      = "Average daily intensity",
    colour = "User Id"
  ) +
  
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(size = 12),
    legend.position = "left",
    legend.key.size = unit(0.4, "cm"),
    legend.text = element_text(size = 8)
  )
```

## Intensity increases consistently with step volume {.unnumbered}

The chart reveals a direct relationship between step volume and average intensity: the more users walk, the higher their sustained effort.
The correlation is linear: higher volume is accompanied by higher intensity, reflecting a combination of quantity and quality of effort.

A few atypical users exhibit few steps but high intensity, suggesting short but intense workouts.

The most active users combine frequent movement with sustained effort, whereas the least active users remain close to sedentary behavior.

# Barplot: Analysis of calorie expenditure by daily intensity level

```{r barplot-calorie-intensity}
# Simple categorization of average intensity
df_intensity_cal <- df_users %>%
  mutate(
    intensity_group = case_when(
      mean_intensity < 0.12 ~ "Low intensity",
      mean_intensity < 0.22 ~ "Moderate intensity",
      TRUE                  ~ "High intensity"
    )
  ) %>%
  group_by(intensity_group) %>%
  summarise(
    mean_calories = mean(mean_calories, na.rm = TRUE),
    n_users = n(),
    .groups = "drop"
  )

# Barplot
ggplot(df_intensity_cal, aes(x = intensity_group, y = mean_calories, fill = intensity_group)) +
  geom_col(alpha = 0.85) +
  scale_y_continuous(labels = scales::label_comma(big.mark = " ", decimal.mark = ",")) +
  labs(
    title = "Average Calories by Daily Intensity Level",
    x = "Intensity group",
    y = "Average calories burned per day",
    fill = "Intensity level"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 13)
  )
```

## Higher daily intensity leads to higher calorie expenditure {.unnumbered}

Three levels stand out clearly:

* **High intensity**: ~2400 kcal/day, driven by a large volume of moderate to vigorous minutes, indicating strong physical engagement.
* **Moderate intensity**: ~2100 kcal/day, an active profile with fewer effort peaks, consistent with regular but not strenuous activity.
* **Low intensity**: ~1950 kcal/day, marked by predominantly sedentary behavior and few true effort episodes.

Intensity is therefore a key driver of energy expenditure, beyond step count.
This hierarchical relationship allows segmentation of user profiles and supports recommendations encouraging more sustained effort to increase daily calorie burn.
